<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herizon</title>
    
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* === [ä¹‹å‰æ‰€æœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜] === */
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(45deg, #efc7c7 20%, #FFD4EE 80%);
            color: #333;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .search-box {
            width: 100%;
            max-width: 500px;
            margin: 20px 0 40px 0;
        }
        .search-box input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1em;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            outline: none;
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            box-shadow: 0 4px 25px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .main-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 40px;
        }
        .main-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            padding: 25px 20px;
            font-size: 1.3em;
            font-weight: 600;
            color: #5a67d8;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .main-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            background: white;
        }
        .main-btn .icon {
            font-size: 1.8em;
        }

        #forum-interface {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }
        .forum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 15px;
        }
        .forum-header h2 {
            color: #4a5568;
            margin: 0;
        }
        .close-forum {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .close-forum:hover {
            background: #c53030;
        }

        .post-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
        }
        .form-group textarea {
            min-height: 80px;
        }
        .submit-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        .submit-btn:hover {
            background: #5a67d8;
        }

        .posts-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .post-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .post-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .post-author {
            font-weight: bold;
            color: #4a5568;
        }
        .post-time {
            font-size: 0.85em;
            color: #718096;
        }
        .post-content {
            color: #2d3748;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .post-actions {
            display: flex;
            gap: 15px;
        }
        .post-action {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }
        .post-action:hover {
            color: #667eea;
        }

        /* è®ºå›æ ‡ç­¾é¡µ */
        .forum-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            color: #718096;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        .tab-btn:hover {
            color: #4a5568;
        }

        /* å¸–å­æ ‡ç­¾æ ·å¼ */
        .post-tags {
            margin-top: 8px;
            margin-bottom: 12px;
        }
        .tag {
            display: inline-block;
            background: #edf2f7;
            color: #4a5568;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .main-buttons {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2.2em;
            }
        }
        .post-action[style*="background: #e53e3e"] {
    background: #e53e3e !important;
    color: white !important;
    border: none !important;
    border-radius: 5px !important;
    padding: 5px 10px !important;
}

.post-action[style*="background: #e53e3e"]:hover {
    background: #c53030 !important;
}
        /* === æ‰‹æœºç«¯å›å¤å¼¹çª—æ ·å¼ === */
    .replies-popup {
        width: 95vw !important;
        max-height: 85vh !important;
        padding: 15px !important;
    }
    
    .reply-item {
        padding: 8px 0 !important;
    }
    
    input, textarea {
        font-size: 16px !important;
    }
}
    </style>
</head>
<body>
    <div class="main-container">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="header">
            <h1>æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„ç½‘ç«™ï¼</h1>
            <p>æ¢ç´¢ã€äº¤æµã€å…±åˆ›æœªæ¥</p>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <input type="text" id="global-search" placeholder="æœç´¢å¸–å­ã€è¯é¢˜...ç‚¹å‡»å›è½¦é”®å³å¯">
        </div>

        <!-- å››ä¸ªä¸»åŠŸèƒ½æŒ‰é’® -->
        <div class="main-buttons">
            <button class="main-btn" onclick="openForum('free')">
                <span class="icon">ğŸ’¬</span>
                <span>è‡ªç”±è®ºå›</span>
                <small>ç•…æ‰€æ¬²è¨€ï¼Œè‡ªç”±äº¤æµ</small>
            </button>
            <button class="main-btn" onclick="openForum('academic')">
                <span class="icon">ğŸ”¬</span>
                <span>ç„¦ç‚¹å‰ç»</span>
                <small>æœ€æ–°åŠ¨æ€ä¸è¶‹åŠ¿</small>
            </button>
            <button class="main-btn" onclick="openForum('legal')">
                <span class="icon">âš–ï¸</span>
                <span>æ³•å¾‹æƒç›Š</span>
                <small>æ³•å¾‹çŸ¥è¯†ä¸æƒç›Šä¿éšœ</small>
            </button>
            <button class="main-btn" onclick="openForum('feedback')">
                <span class="icon">ğŸ’¡</span>
                <span>å¼€å‘å»ºè®®</span>
                <small>ä»¥åŠä½¿ç”¨è¯´æ˜</small>
            </button>
        </div>

        <!-- è®ºå›ç•Œé¢ -->
        <div id="forum-interface">
            <!-- å†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
let supabase;
    try {
        const SUPABASE_URL = 'https://sojzrexhxicfugyuvsaa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvanpyZXhoeGljZnVneXV2c2FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NzU0MTksImV4cCI6MjA3ODE1MTQxOX0.ZTm01JLRoakcQ3AnTOTQDUR5-Fu6l5TKtrlRSx6MUAE';
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
        // åˆ›å»ºè™šæ‹Ÿçš„ supabase å¯¹è±¡é˜²æ­¢åç»­é”™è¯¯
        supabase = {
            from: () => ({ 
                select: () => ({ eq: () => ({ order: () => Promise.resolve({ data: [], error: null }) }) }),
                insert: () => ({ select: () => Promise.resolve({ data: null, error: new Error('Supabaseæœªé…ç½®') }) })
            })
        };
    }

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentForumType = '';
        let currentSortType = 'latest';

        // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================

        async function openForum(type) {
            currentForumType = type;
            const interface = document.getElementById('forum-interface');
            const titles = {
                'free': 'ğŸ’¬ è‡ªç”±è®ºå› - ç•…æ‰€æ¬²è¨€',
                'academic': 'ğŸ”¬ ç„¦ç‚¹å‰ç» - æ¢ç´¢å‰æ²¿', 
                'legal': 'âš–ï¸ æ³•å¾‹æƒç›Š - æ³•å¾‹æ­¦å™¨',
                'feedback': 'ğŸ’¡ å¼€å‘å»ºè®® - å…±å»ºç¤¾åŒº'
            };

            interface.style.display = 'block';
            interface.innerHTML = `
                <div class="forum-header">
                    <h2>${titles[type]}</h2>
                    <button class="close-forum" onclick="closeForum()">å…³é—­</button>
                </div>
                <div class="post-form">
                    <div class="form-group">
                        <input type="text" id="post-author" placeholder="ä½ çš„æ˜µç§° (å¿…å¡«)">
                    </div>
                    <div class="form-group">
                        <textarea id="post-content" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„å†…å®¹... (å¿…å¡«)"></textarea>
                    </div>
                    ${type === 'free' ? '<div class="form-group"><input type="text" id="post-tags" placeholder="æ·»åŠ æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš” (å¯é€‰)"></div>' : ''}
                    <button class="submit-btn" onclick="publishPost()">å‘å¸ƒå¸–å­</button>
                </div>
                <div class="forum-tabs">
                    <button class="tab-btn active" onclick="switchTab('latest')">æœ€æ–°</button>
                    ${type === 'free' ? '<button class="tab-btn" onclick="switchTab(\'hot\')">æœ¬å‘¨æœ€çƒ­</button>' : ''}
                </div>
                <div class="posts-container" id="posts-container">
                    <p style="text-align: center; color: #718096;">åŠ è½½ä¸­...</p>
                </div>
            `;
            
            interface.scrollIntoView({ behavior: 'smooth' });
            await loadPosts('latest');
        }

        function closeForum() {
            document.getElementById('forum-interface').style.display = 'none';
        }

        async function publishPost() {
            const author = document.getElementById('post-author').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const tagsInput = document.getElementById('post-tags') ? document.getElementById('post-tags').value.trim() : '';

            if (!author || !content) {
                alert('è¯·å¡«å†™æ˜µç§°å’Œå†…å®¹ï¼');
                return;
            }

            try {
                // æ’å…¥æ•°æ®åˆ° Supabase
                const { data, error } = await supabase
                    .from('posts')
                    .insert([
                        {
                            author: author,
                            content: content,
                            type: currentForumType,
                            tags: tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : [],
                            likes: 0
                        }
                    ])
                    .select();

                if (error) throw error;

                // æ¸…ç©ºè¡¨å•
                document.getElementById('post-author').value = '';
                document.getElementById('post-content').value = '';
                if (document.getElementById('post-tags')) {
                    document.getElementById('post-tags').value = '';
                }

                // é‡æ–°åŠ è½½å¸–å­
                await loadPosts(currentSortType);
                alert('å¸–å­å‘å¸ƒæˆåŠŸï¼');

            } catch (error) {
                console.error('å‘å¸ƒå¸–å­é”™è¯¯:', error);
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ä¿¡æ¯ã€‚');
            }
        }

        async function loadPosts(sortType) {
            currentSortType = sortType;
            const postsContainer = document.getElementById('posts-container');
            
            try {
                let query = supabase
                    .from('posts')
                    .select('*')
                    .eq('type', currentForumType);

                // æ’åº
                if (sortType === 'latest') {
                    query = query.order('created_at', { ascending: false });
                } else if (sortType === 'hot') {
                    query = query.order('likes', { ascending: false });
                }

                const { data: posts, error } = await query;

                if (error) throw error;

                if (!posts || posts.length === 0) {
                    postsContainer.innerHTML = '<p style="text-align: center; color: #718096;">è¿˜æ²¡æœ‰å¸–å­ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
                    return;
                }

                postsContainer.innerHTML = posts.map(post => `
    <div class="post-item">
        <div class="post-header">
            <span class="post-author">${post.author}</span>
            <span class="post-time">${new Date(post.created_at).toLocaleString('zh-CN')}</span>
        </div>
        <div class="post-content">${post.content}</div>
        ${post.tags && post.tags.length > 0 ? 
            `<div class="post-tags">æ ‡ç­¾: ${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
        
        <div class="post-actions">
            <div style="display: flex; gap: 15px;">
                <button class="post-action" onclick="likePost(${post.id})">
                    <span>ğŸ‘</span> <span class="like-count">${post.likes}</span>
                </button>
                <button class="post-action" onclick="replyToPost(${post.id})">
                    <span>ğŸ’¬</span> æŸ¥çœ‹/å›å¤
                </button>
            </div>
            <button class="post-action" onclick="adminDeletePost(${post.id})" style="background: #e53e3e; color: white;">
                <span></span> <span>ç®¡ç†å‘˜åˆ é™¤</span>
            </button>
        </div>
    </div>
`).join('');
                
            } catch (error) {
                console.error('åŠ è½½å¸–å­é”™è¯¯:', error);
                postsContainer.innerHTML = '<p style="text-align: center; color: #e53e3e;">åŠ è½½å¸–å­å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚</p>';
            }
        }

        function switchTab(tabType) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadPosts(tabType);
        }

        async function likePost(postId) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç‚¹èµè¿‡
    const likedPosts = JSON.parse(localStorage.getItem('likedPosts')) || [];
    if (likedPosts.includes(postId)) {
        alert('ä½ å·²ç»ç‚¹è¿‡èµäº†ï¼');
        return;
    }

    try {
        // å…ˆè·å–å½“å‰ç‚¹èµæ•°
        const { data: post, error: fetchError } = await supabase
            .from('posts')
            .select('likes')
            .eq('id', postId)
            .single();

        if (fetchError) throw fetchError;

        // æ›´æ–°ç‚¹èµæ•°
        const { error: updateError } = await supabase
            .from('posts')
            .update({ likes: post.likes + 1 })
            .eq('id', postId);

        if (updateError) throw updateError;

        // è®°å½•ç”¨æˆ·å·²ç‚¹èµ
        likedPosts.push(postId);
        localStorage.setItem('likedPosts', JSON.stringify(likedPosts));
        
        // é‡æ–°åŠ è½½å¸–å­
        await loadPosts(currentSortType);
        
    } catch (error) {
        console.error('ç‚¹èµé”™è¯¯:', error);
        alert('ç‚¹èµå¤±è´¥ï¼');
    }
}
        //ç®¡ç†å‘˜åˆ é™¤
        async function adminDeletePost(postId) {
    const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
    if (password !== 'wangyujiezsjz0') {  // ä½ çš„å¯†ç 
        alert('å¯†ç é”™è¯¯ï¼');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿ')) return;
    
    try {
        await supabase.from('replies').delete().eq('post_id', postId);
        await supabase.from('posts').delete().eq('id', postId);
        alert('åˆ é™¤æˆåŠŸï¼');
        await loadPosts(currentSortType);
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥ï¼');
    }
}
        
        async function replyToPost(postId) {
    try {
        // è·å–ç°æœ‰å›å¤
        const { data: replies, error } = await supabase
            .from('replies')
            .select('*')
            .eq('post_id', postId)
            .order('created_at', { ascending: true });
            
        if (error) throw error;
        
        // åˆ›å»ºå›å¤æ˜¾ç¤ºåŒºåŸŸ
        let repliesHTML = '<div class="replies-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; max-width: 90vw; max-height: 80vh; overflow-y: auto;">';
        repliesHTML += '<h3 style="margin-top: 0;">ğŸ’¬ å›å¤åˆ—è¡¨</h3>';
        
        if (replies && replies.length > 0) {
            replies.forEach((reply, index) => {
                repliesHTML += `
                    <div class="reply-item" style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <div style="font-weight: bold; color: #667eea;">${reply.author}</div>
                        <div style="margin: 5px 0;">${reply.content}</div>
                        <div style="font-size: 12px; color: #999;">${new Date(reply.created_at).toLocaleString('zh-CN')}</div>
                    </div>
                `;
            });
        } else {
            repliesHTML += '<p style="text-align: center; color: #999;">æš‚æ— å›å¤</p>';
        }
        
        // æ·»åŠ å›å¤è¡¨å•
        repliesHTML += `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #667eea;">
                <h4> æ·»åŠ å›å¤</h4>
                <input type="text" id="reply-author-${postId}" placeholder="ä½ çš„æ˜µç§°" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                <textarea id="reply-content-${postId}" placeholder="å›å¤å†…å®¹..." style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; min-height: 80px;"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="publishReply(${postId})" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">å‘å¸ƒå›å¤</button>
                    <button onclick="closeRepliesPopup()" style="padding: 10px 20px; background: #999; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        `;
        
        repliesHTML += '</div>';
        
        // æ·»åŠ é®ç½©å±‚
        repliesHTML += '<div class="overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>';
        
        // æ˜¾ç¤ºåˆ°é¡µé¢
        const popupContainer = document.createElement('div');
        popupContainer.id = 'replies-popup-container';
        popupContainer.innerHTML = repliesHTML;
        document.body.appendChild(popupContainer);
        
    } catch (error) {
        console.error('é”™è¯¯:', error);
        alert('åŠ è½½å›å¤å¤±è´¥ï¼');
    }
}

// å‘å¸ƒå›å¤å‡½æ•°
async function publishReply(postId) {
    const author = document.getElementById(`reply-author-${postId}`).value.trim();
    const content = document.getElementById(`reply-content-${postId}`).value.trim();
    
    if (!author || !content) {
        alert('è¯·å¡«å†™æ˜µç§°å’Œå›å¤å†…å®¹ï¼');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('replies')
            .insert([{ 
                post_id: postId, 
                author: author, 
                content: content 
            }]);

        if (error) throw error;
        
        alert('å›å¤æˆåŠŸï¼');
        closeRepliesPopup();
        
    } catch (error) {
        console.error('å›å¤é”™è¯¯:', error);
        alert('å›å¤å¤±è´¥ï¼');
    }
}

// å…³é—­å›å¤å¼¹çª—
function closeRepliesPopup() {
    const popup = document.getElementById('replies-popup-container');
    if (popup) {
        popup.remove();
    }
}

// ç‚¹å‡»é®ç½©å±‚å…³é—­
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('overlay')) {
        closeRepliesPopup();
    }
});
        // ==================== æœç´¢åŠŸèƒ½ ====================

        // ç›‘å¬è¾“å…¥æ¡†çš„è¾“å…¥äº‹ä»¶ï¼ˆå®æ—¶æœç´¢ï¼‰
document.getElementById('global-search').addEventListener('input', debounce(async function(e) {
    await performSearch(e.target.value.trim());
}, 300));

// ç›‘å¬è¾“å…¥æ¡†çš„å›è½¦é”®
document.getElementById('global-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch(e.target.value.trim());
    }
});

// é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹æœç´¢
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// æ‰§è¡Œæœç´¢çš„æ ¸å¿ƒå‡½æ•°
async function performSearch(searchTerm) {
    if (!searchTerm) {
        // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œæ¢å¤æ˜¾ç¤ºå½“å‰è®ºå›çš„å¸–å­
        if (currentForumType) {
            await loadPosts(currentSortType);
        }
        return;
    }
    
    try {
        const { data: posts, error } = await supabase
            .from('posts')
            .select('*')
            .or(`content.ilike.%${searchTerm}%,author.ilike.%${searchTerm}%,tags.cs.{${searchTerm}}`)
            .order('created_at', { ascending: false });

        if (error) throw error;

        const postsContainer = document.getElementById('posts-container');
        if (!postsContainer) {
            // å¦‚æœä¸åœ¨è®ºå›ç•Œé¢ï¼Œå…ˆæ‰“å¼€è‡ªç”±è®ºå›
            await openForum('free');
        }
        
        const finalPostsContainer = document.getElementById('posts-container');
        
        if (posts && posts.length > 0) {
            finalPostsContainer.innerHTML = `
                <div style="margin-bottom: 15px; color: #667eea; font-weight: 600;">
                    æœç´¢"${searchTerm}"çš„ç»“æœ (${posts.length}æ¡)
                </div>
                ${posts.map(post => `
                <div class="post-item">
                    <div class="post-header">
                        <span class="post-author">${post.author}</span>
                        <span class="post-time">${new Date(post.created_at).toLocaleString('zh-CN')}</span>
                        <span class="post-category" style="background: #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">
                            ${getCategoryName(post.type)}
                        </span>
                    </div>
                    <div class="post-content">${highlightSearchTerm(post.content, searchTerm)}</div>
                    ${post.tags && post.tags.length > 0 ? 
                        `<div class="post-tags">æ ‡ç­¾: ${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                    <div class="post-actions">
                        <button class="post-action" onclick="likePost(${post.id})">
                            <span>ğŸ‘</span> <span class="like-count">${post.likes}</span>
                        </button>
                    </div>
                </div>
                `).join('')}
            `;
        } else {
            finalPostsContainer.innerHTML = '<p style="text-align: center; color: #718096;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å¸–å­ã€‚</p>';
        }
    } catch (error) {
        console.error('æœç´¢é”™è¯¯:', error);
        const postsContainer = document.getElementById('posts-container');
        postsContainer.innerHTML = '<p style="text-align: center; color: #e53e3e;">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
    }
}

// é«˜äº®æœç´¢å…³é”®è¯
function highlightSearchTerm(content, searchTerm) {
    if (!searchTerm) return content;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return content.replace(regex, '<mark style="background: #ffeb3b; padding: 1px 2px;">$1</mark>');
}

// è·å–åˆ†ç±»åç§°
function getCategoryName(type) {
    const categories = {
        'free': 'è‡ªç”±è®ºå›',
        'academic': 'å­¦æœ¯å‰ç»', 
        'legal': 'æ³•å¾‹æƒç›Š',
        'feedback': 'å¼€å‘å»ºè®®'
    };
    return categories[type] || 'æœªçŸ¥';
}

        // åˆå§‹åŒ–
        console.log('Supabase ç¤¾åŒºç½‘ç«™å·²åŠ è½½');
    </script>
</body>
</html>
